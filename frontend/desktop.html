<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o de Produ√ß√£o - Desktop</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/dark-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: #111111;
            color: white;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            border-right: 1px solid #2a2a2a;
        }

        .sidebar-header {
            padding: 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #2a2a2a;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 32px;
            color: #3498db;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: #ecf0f1;
        }

        .sidebar-menu {
            flex: 1;
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: #a1a1aa;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            border-radius: 8px;
            margin: 2px 8px;
            font-weight: 500;
        }

        .menu-item:hover {
            background: #2a2a2a;
            color: #ffffff;
            transform: translateX(4px);
        }

        .menu-item.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .menu-item i {
            margin-right: 12px;
            font-size: 20px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0a0a0a;
        }

        .top-bar {
            background: #1a1a1a;
            padding: 15px 30px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .page-title {
            font-size: 24px;
            font-weight: 500;
            color: #2c3e50;
        }

        .status-indicators {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-online {
            background: #e8f5e8;
            color: #27ae60;
        }

        .status-offline {
            background: #ffebee;
            color: #e74c3c;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #0a0a0a;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard-card {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            margin-bottom: 20px;
            border: 1px solid #2a2a2a;
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            border-color: #404040;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-icon {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 500;
            color: #2c3e50;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
        }

        .btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .server-info {
            font-size: 14px;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .server-info div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .server-info strong {
            color: #2c3e50;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .device-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid #3498db;
        }

        .device-info {
            flex: 1;
        }

        .device-name {
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
        }

        .device-details {
            font-size: 12px;
            color: #7f8c8d;
        }

        .device-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-authorize {
            background: #27ae60;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.3s ease;
        }

        .btn-authorize:hover {
            background: #219a52;
        }

        .btn-reject {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.3s ease;
        }

        .btn-reject:hover {
            background: #c0392b;
        }

        .btn-revoke {
            background: #f39c12;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.3s ease;
        }

        .btn-revoke:hover {
            background: #e67e22;
        }

        .device-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-authorized {
            background: #d4edda;
            color: #155724;
        }

        .status-revoked {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
        }

        .url-copy {
            cursor: pointer;
            color: #3498db;
            text-decoration: underline;
        }

        .url-copy:hover {
            color: #2980b9;
        }

        .tunnel-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
            margin-top: 8px;
        }

        .tunnel-connected {
            background: #e8f5e8;
            color: #27ae60;
        }

        .tunnel-disconnected {
            background: #ffebee;
            color: #e74c3c;
        }

        .tunnel-connecting {
            background: #fff3cd;
            color: #856404;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #3498db;
        }

        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .logs-container {
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
        }

        .log-entry {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .log-timestamp {
            color: #95a5a6;
        }

        .log-level-info {
            color: #3498db;
        }

        .log-level-error {
            color: #e74c3c;
        }

        .log-level-warning {
            color: #f39c12;
        }

        .log-level-success {
            color: #27ae60;
        }

        .product-category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .category-tab:hover {
            background: #f8f9fa;
        }

        .category-tab.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .products-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .product-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .product-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-color: #3498db;
        }

        .product-info {
            padding: 15px;
        }

        .product-name {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .product-name strong {
            font-size: 16px;
            color: #2c3e50;
        }

        .product-code {
            font-size: 12px;
            color: #7f8c8d;
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .product-details {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
            font-size: 12px;
            color: #7f8c8d;
        }

        .product-description {
            font-size: 14px;
            color: #555;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .product-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #28a745;
            color: white;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-edit:hover {
            background: #218838;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .orders-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .order-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .order-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-code {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .order-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .order-status.completed {
            background: #e8f5e8;
            color: #27ae60;
        }

        .order-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .order-details {
            padding: 15px;
        }

        .order-products {
            margin-top: 10px;
        }

        .order-product {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .order-product:last-child {
            border-bottom: none;
        }

        .order-meta {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
            color: #7f8c8d;
        }

        /* Estilos do Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .modal-header {
            margin-top: 0;
            color: #2c3e50;
        }

        .modal-close {
            cursor: pointer;
            color: #bdc3c7;
            float: right;
            font-size: 18px;
        }

        .modal-close:hover {
            color: #e74c3c;
        }

        .modal-body {
            margin-bottom: 15px;
        }

        .modal-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .modal-input,
        .modal-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .modal-button.cancel {
            background: white;
            border: 1px solid #ddd;
            color: #333;
        }

        .modal-button.cancel:hover {
            background: #f8f9fa;
        }

        .modal-button.add {
            background: #27ae60;
            color: white;
        }

        .modal-button.add:hover {
            background: #219a52;
        }

        /* Auto-Update Styles */
        .update-status-checking {
            color: #3498db !important;
        }

        .update-status-available {
            color: #27ae60 !important;
            font-weight: 600;
        }

        .update-status-error {
            color: #e74c3c !important;
        }

        .update-status-ready {
            color: #f39c12 !important;
            font-weight: 600;
        }

        .update-progress-container {
            margin-top: 10px;
        }

        .update-progress-bg {
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
            height: 20px;
        }

        .update-progress-bar {
            background: linear-gradient(45deg, #3498db, #2980b9);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .update-progress-details {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: center;
        }

        .update-error-container {
            margin-top: 10px;
            padding: 10px;
            background: #ffe6e6;
            border-left: 4px solid #e74c3c;
            border-radius: 4px;
        }

        .update-error-title {
            color: #e74c3c;
            font-weight: 600;
        }

        .update-version-info {
            background: #e8f6f3;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
            border-left: 4px solid #27ae60;
        }

        .btn-update {
            background: #3498db;
            border-color: #3498db;
        }

        .btn-update:hover {
            background: #2980b9;
            border-color: #2980b9;
        }

        .btn-install {
            background: #f39c12;
            border-color: #f39c12;
        }

        .btn-install:hover {
            background: #e67e22;
            border-color: #e67e22;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="material-icons">factory</i>
                    <div class="logo-text">Gest√£o de Produ√ß√£o</div>
                </div>
            </div>
            <div class="sidebar-menu">
                <button class="menu-item active" onclick="showTab('dashboard')">
                    <i class="material-icons">dashboard</i>
                    <span>Dashboard</span>
                </button>
                <button class="menu-item" onclick="showTab('products')">
                    <i class="material-icons">inventory</i>
                    <span>Produtos</span>
                </button>
                <button class="menu-item" onclick="showTab('orders')">
                    <i class="material-icons">assignment</i>
                    <span>Ordens</span>
                </button>
                <button class="menu-item" onclick="showTab('devices')">
                    <i class="material-icons">devices</i>
                    <span>Dispositivos</span>
                </button>
                <button class="menu-item" onclick="showTab('logs')">
                    <i class="material-icons">history</i>
                    <span>Logs do Sistema</span>
                </button>
                <button class="menu-item" onclick="showTab('settings')">
                    <i class="material-icons">settings</i>
                    <span>Configura√ß√µes</span>
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="top-bar">
                <div class="page-title" id="page-title">Dashboard</div>
                <div class="status-indicators">
                    <div class="status-item" id="system-status">
                        <i class="material-icons">power</i>
                        <span>Sistema: Carregando...</span>
                    </div>
                    <div class="status-item" id="server-status-indicator">
                        <i class="material-icons">cloud</i>
                        <span>Servidor: Carregando...</span>
                    </div>
                </div>
            </div>

            <div class="content-area">
                <!-- Tab: Dashboard -->
                <div id="dashboard-tab" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-server">-</div>
                            <div class="stat-label">Status Servidor</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-tunnel">-</div>
                            <div class="stat-label">Acesso Externo</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-devices">-</div>
                            <div class="stat-label">Dispositivos Ativos</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="material-icons">settings</i>
                            </div>
                            <div class="card-title">Controle do Servidor</div>
                        </div>
                        <div class="server-info">
                            <div>
                                <strong>Status:</strong>
                                <span id="server-status" class="status-badge">Carregando...</span>
                            </div>
                            <div>
                                <strong>IP Local:</strong>
                                <span id="local-ip" class="url-copy" onclick="copyToClipboard(this)">Detectando...</span>
                            </div>
                            <div>
                                <strong>Porta:</strong>
                                <span id="server-port">-</span>
                            </div>
                            <div>
                                <strong>URL Local:</strong>
                                <span id="local-url" class="url-copy" onclick="copyToClipboard(this)">-</span>
                            </div>
                            <div>
                                <strong>URL Externo:</strong>
                                <span id="external-url" class="url-copy" onclick="copyToClipboard(this)">Configurando...</span>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-success" id="start-btn" onclick="startServer()">
                                <i class="material-icons">play_arrow</i>
                                Iniciar Servidor
                            </button>
                            <button class="btn btn-danger" id="stop-btn" onclick="stopServer()">
                                <i class="material-icons">stop</i>
                                Parar Servidor
                            </button>
                            <button class="btn btn-primary" id="restart-btn" onclick="restartServer()">
                                <i class="material-icons">refresh</i>
                                Reiniciar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Products -->
                <div id="products-tab" class="tab-content">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="material-icons">inventory</i>
                            </div>
                            <div class="card-title">Gerenciar Produtos</div>
                        </div>
                        
                        <div class="product-category-tabs">
                            <button class="category-tab active" data-category="PT" onclick="switchProductCategory('PT')">Papel Toalha (PT)</button>
                            <button class="category-tab" data-category="PH" onclick="switchProductCategory('PH')">Papel Higi√™nico (PH)</button>
                            <button class="category-tab" data-category="TB" onclick="switchProductCategory('TB')">Toalha Bobina (TB)</button>
                            <button class="category-tab" data-category="ST" onclick="switchProductCategory('ST')">Sacos e Talheres (ST)</button>
                            <button class="category-tab" data-category="GN" onclick="switchProductCategory('GN')">Guardanapos (GN)</button>
                        </div>

                        <div id="products-list" class="products-list">
                            <div class="loading">Carregando produtos...</div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="openAddProductModal()">
                                <i class="material-icons">add</i>
                                Adicionar Produto
                            </button>
                            <button class="btn btn-primary" onclick="importProducts()">
                                <i class="material-icons">upload</i>
                                Importar Produtos
                            </button>
                            <button class="btn btn-primary" onclick="exportProducts()">
                                <i class="material-icons">download</i>
                                Exportar Produtos
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Orders -->
                <div id="orders-tab" class="tab-content">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="material-icons">assignment</i>
                            </div>
                            <div class="card-title">Ordens de Produ√ß√£o</div>
                        </div>
                        
                        <div id="orders-summary" class="summary-box">
                            <strong>Resumo:</strong> <span id="orders-count">Carregando...</span>
                        </div>

                        <div class="orders-list" id="orders-list">
                            <div class="loading">Carregando ordens...</div>
                        </div>

                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="refreshOrders()">
                                <i class="material-icons">refresh</i>
                                Atualizar Ordens
                            </button>
                            <button class="btn btn-success" onclick="exportOrders()">
                                <i class="material-icons">download</i>
                                Exportar Ordens
                            </button>
                            <button class="btn btn-danger" onclick="clearCompletedOrders()">
                                <i class="material-icons">clear_all</i>
                                Limpar Conclu√≠das
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Devices -->
                <div id="devices-tab" class="tab-content">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="material-icons">devices</i>
                            </div>
                            <div class="card-title">Dispositivos Conectados</div>
                        </div>
                        <div id="devices-summary" class="summary-box">
                            <strong>Resumo:</strong> <span id="device-count">Carregando...</span>
                        </div>
                        <div class="device-list" id="devices-list">
                            <div class="loading">Carregando dispositivos...</div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-danger button-spacing" onclick="clearDevicesList()">
                                <i class="material-icons">clear_all</i>
                                Limpar Lista
                            </button>
                            <button class="btn btn-success" onclick="exportDevices()">
                                <i class="material-icons">download</i>
                                Exportar Lista
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Logs -->
                <div id="logs-tab" class="tab-content">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="material-icons">history</i>
                            </div>
                            <div class="card-title">Logs do Sistema</div>
                        </div>
                        <div class="logs-container" id="logs-container">
                            <div class="loading">Carregando logs...</div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="refreshLogs()">
                                <i class="material-icons">refresh</i>
                                Atualizar Logs
                            </button>
                            <button class="btn btn-danger" onclick="clearLogs()">
                                <i class="material-icons">clear_all</i>
                                Limpar Logs
                            </button>
                            <button class="btn btn-success" onclick="exportLogs()">
                                <i class="material-icons">download</i>
                                Exportar Logs
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Settings -->
                <div id="settings-tab" class="tab-content">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="material-icons">settings</i>
                            </div>
                            <div class="card-title">Configura√ß√µes do Sistema</div>
                        </div>
                        <div class="server-info">
                            <div>
                                <strong>Porta do Servidor:</strong>
                                <input type="number" id="server-port-setting" value="3000" class="form-input">
                            </div>
                            <div>
                                <strong>Auto-iniciar Servidor:</strong>
                                <input type="checkbox" id="auto-start-setting">
                            </div>
                            <div>
                                <strong>Backup Autom√°tico:</strong>
                                <input type="checkbox" id="auto-backup-setting">
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="saveSettings()">
                                <i class="material-icons">save</i>
                                Salvar Configura√ß√µes
                            </button>
                            <button class="btn btn-primary" onclick="backupData()">
                                <i class="material-icons">backup</i>
                                Fazer Backup
                            </button>
                            <button class="btn btn-primary" onclick="restoreData()">
                                <i class="material-icons">restore</i>
                                Restaurar Dados
                            </button>
                        </div>
                    </div>

                    <!-- Auto-Update Panel -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="material-icons">system_update</i>
                            </div>
                            <div class="card-title">Atualiza√ß√µes Autom√°ticas</div>
                        </div>
                        <div class="server-info">
                            <div>
                                <strong>Status das Atualiza√ß√µes:</strong>
                                <span id="update-status" class="update-status-checking">Verificando...</span>
                            </div>
                            <div id="update-version-info" class="update-version-info hidden">
                                <strong>üéâ Vers√£o Dispon√≠vel:</strong>
                                <span id="available-version">-</span>
                            </div>
                            <div id="update-progress-container" class="update-progress-container hidden">
                                <strong>Progresso do Download:</strong>
                                <div class="update-progress-bg">
                                    <div id="update-progress-bar" class="update-progress-bar">
                                        0%
                                    </div>
                                </div>
                                <div id="update-progress-details" class="update-progress-details">
                                    Preparando download...
                                </div>
                            </div>
                            <div id="update-error-container" class="update-error-container hidden">
                                <span class="update-error-title">‚ùå Erro:</span>
                                <span id="update-error-message">-</span>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary btn-update" id="check-updates-btn" onclick="checkForUpdates()">
                                <i class="material-icons">search</i>
                                Verificar Atualiza√ß√µes
                            </button>
                            <button class="btn btn-success hidden" id="download-update-btn" onclick="downloadUpdate()">
                                <i class="material-icons">download</i>
                                Baixar Atualiza√ß√£o
                            </button>
                            <button class="btn btn-warning btn-install hidden" id="install-update-btn" onclick="installUpdate()">
                                <i class="material-icons">install_desktop</i>
                                Instalar e Reiniciar
                            </button>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="material-icons">info</i>
                            </div>
                            <div class="card-title">Informa√ß√µes do Sistema</div>
                        </div>
                        <div class="server-info">
                            <div>
                                <strong>Vers√£o:</strong>
                                <span>1.0.0</span>
                            </div>
                            <div>
                                <strong>Electron:</strong>
                                <span id="electron-version">Carregando...</span>
                            </div>
                            <div>
                                <strong>Node.js:</strong>
                                <span id="node-version">Carregando...</span>
                            </div>
                            <div>
                                <strong>Sistema:</strong>
                                <span id="os-version">Carregando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar produto -->
    <div id="addProductModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">Adicionar Novo Produto</h3>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nome do produto:</label>
                <input type="text" id="modalProductName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Digite o nome do produto">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Categoria:</label>
                <select id="modalProductCategory" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="PT">Papel Toalha (PT)</option>
                    <option value="PH">Papel Higi√™nico (PH)</option>
                    <option value="TB">Toalha Bobina (TB)</option>
                    <option value="ST">Sacos e Talheres (ST)</option>
                    <option value="GN">Guardanapos (GN)</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Descri√ß√£o:</label>
                <input type="text" id="modalProductDescription" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Descri√ß√£o do produto (opcional)">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Unidade:</label>
                <input type="text" id="modalProductUnit" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="un" value="un">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeAddProductModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancelar</button>
                <button onclick="submitNewProduct()" style="padding: 10px 20px; border: none; background: #27ae60; color: white; border-radius: 4px; cursor: pointer;">Adicionar</button>
            </div>
        </div>
    </div>
    <script>
        // Vari√°veis globais
        let updateInterval;
        let serverStatus = { running: false };
        let currentTab = 'dashboard';
        let currentProductCategory = 'PT';
        let products = [];
        let orders = [];

        // Sistema de navega√ß√£o por tabs
        function showTab(tabName) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover classe active de todos os menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Mostrar tab selecionada
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Ativar menu item correspondente
            event.target.closest('.menu-item').classList.add('active');
            
            // Atualizar t√≠tulo da p√°gina
            const titles = {
                'dashboard': 'Dashboard',
                'products': 'Produtos',
                'orders': 'Ordens',
                'devices': 'Dispositivos',
                'logs': 'Logs do Sistema',
                'settings': 'Configura√ß√µes'
            };
            document.getElementById('page-title').textContent = titles[tabName];
            
            currentTab = tabName;
            
            // Atualizar conte√∫do espec√≠fico da tab
            if (tabName === 'products') {
                loadProducts();
            } else if (tabName === 'orders') {
                loadOrders();
            } else if (tabName === 'devices') {
                updateDevices();
            } else if (tabName === 'logs') {
                updateLogs();
            }
        }

        // Fun√ß√µes principais do servidor
        async function startServer() {
            try {
                document.getElementById('start-btn').disabled = true;
                showNotification('Iniciando servidor...', 'info');
                
                const result = await window.electronAPI.server.start();
                
                if (result.success) {
                    showNotification('Servidor iniciado com sucesso!', 'success');
                } else {
                    showNotification('Erro ao iniciar servidor: ' + result.message, 'error');
                }
                
                await updateStatus();
            } catch (error) {
                console.error('Erro ao iniciar servidor:', error);
                showNotification('Erro ao iniciar servidor', 'error');
            } finally {
                document.getElementById('start-btn').disabled = false;
            }
        }

        async function stopServer() {
            try {
                document.getElementById('stop-btn').disabled = true;
                
                const result = await window.electronAPI.server.stop();
                
                if (result.success) {
                    showNotification('Servidor parado com sucesso!', 'success');
                } else {
                    showNotification('Erro ao parar servidor: ' + result.message, 'error');
                }
                
                await updateStatus();
            } catch (error) {
                console.error('Erro ao parar servidor:', error);
                showNotification('Erro ao parar servidor', 'error');
            } finally {
                document.getElementById('stop-btn').disabled = false;
            }
        }

        async function restartServer() {
            try {
                document.getElementById('restart-btn').disabled = true;
                showNotification('Reiniciando servidor...', 'info');
                
                await stopServer();
                setTimeout(async () => {
                    await startServer();
                    document.getElementById('restart-btn').disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Erro ao reiniciar servidor:', error);
                showNotification('Erro ao reiniciar servidor', 'error');
                document.getElementById('restart-btn').disabled = false;
            }
        }

        // Atualizar status do sistema
        async function updateStatus() {
            try {
                const status = await window.electronAPI.server.getStatus();
                serverStatus = status;
                
                // Atualizar indicadores no topo
                const systemStatus = document.getElementById('system-status');
                const serverStatusIndicator = document.getElementById('server-status-indicator');
                
                systemStatus.className = 'status-item status-online';
                systemStatus.innerHTML = '<i class="material-icons">power</i><span>Sistema: Online</span>';
                
                if (status.running) {
                    serverStatusIndicator.className = 'status-item status-online';
                    serverStatusIndicator.innerHTML = '<i class="material-icons">cloud</i><span>Servidor: Online</span>';
                    
                    // Atualizar informa√ß√µes
                    document.getElementById('server-status').textContent = 'ONLINE';
                    document.getElementById('server-status').className = 'status-badge status-online';
                    document.getElementById('local-ip').textContent = status.localIP;
                    document.getElementById('server-port').textContent = status.port;
                    document.getElementById('local-url').textContent = `http://${status.localIP}:${status.port}`;
                    // Stats
                    document.getElementById('stat-server').textContent = 'ON';
                    
                    // Tunnel
                    if (status.tunnelUrl) {
                        document.getElementById('external-url').textContent = status.tunnelUrl;
                        document.getElementById('stat-tunnel').textContent = 'ON';
                    } else {
                        document.getElementById('external-url').textContent = 'Indispon√≠vel';
                        document.getElementById('stat-tunnel').textContent = 'OFF';
                    }
                } else {
                    serverStatusIndicator.className = 'status-item status-offline';
                    serverStatusIndicator.innerHTML = '<i class="material-icons">cloud_off</i><span>Servidor: Offline</span>';
                    
                    document.getElementById('server-status').textContent = 'OFFLINE';
                    document.getElementById('server-status').className = 'status-badge status-offline';
                    document.getElementById('local-ip').textContent = 'Servidor parado';
                    document.getElementById('server-port').textContent = '-';
                    document.getElementById('local-url').textContent = '-';
                    document.getElementById('external-url').textContent = 'Indispon√≠vel';
                    
                    // Stats
                    document.getElementById('stat-server').textContent = 'OFF';
                    document.getElementById('stat-tunnel').textContent = 'OFF';
                }
                
                // Atualizar bot√µes
                document.getElementById('start-btn').disabled = status.running;
                document.getElementById('stop-btn').disabled = !status.running;
                
            } catch (error) {
                console.error('Erro ao obter status:', error);
            }
        }

        // Atualizar dispositivos
        async function updateDevices() {
            try {
                const devices = await window.electronAPI.devices.list();
                const devicesList = document.getElementById('devices-list');
                const deviceCount = document.getElementById('device-count');
                
                if (devices && devices.length > 0) {
                    // FILTRAR APENAS AUTORIZADOS E PENDENTES
                    const filteredDevices = devices.filter(d => d.status === 'authorized' || d.status === 'pending');
                    
                    const authorized = filteredDevices.filter(d => d.status === 'authorized').length;
                    const pending = filteredDevices.filter(d => d.status === 'pending').length;
                    
                    deviceCount.textContent = `${authorized} autorizados, ${pending} pendentes`;
                    document.getElementById('stat-devices').textContent = authorized;
                    
                    if (filteredDevices.length > 0) {
                        devicesList.innerHTML = filteredDevices.map(device => `
                        <div class="device-item">
                            <div class="device-info">
                                <div class="device-name">
                                    ${device.name}
                                    <span class="device-status status-${device.status}">${device.status}</span>
                                </div>
                                <div class="device-details">${device.ip} ‚Ä¢ ${device.user_agent || 'N/A'}</div>
                                <div class="device-details">√öltimo acesso: ${device.last_activity ? new Date(device.last_activity).toLocaleString() : 'Nunca'}</div>
                                <div class="device-actions">
                                    ${device.status === 'pending' ? `
                                        <button class="btn-authorize" onclick="authorizeDevice('${device.device_id}')">
                                            <i class="material-icons" style="font-size: 14px;">check</i>
                                            Autorizar
                                        </button>
                                        <button class="btn-reject" onclick="rejectDevice('${device.device_id}')">
                                            <i class="material-icons" style="font-size: 14px;">close</i>
                                            Rejeitar
                                        </button>
                                    ` : device.status === 'authorized' ? `
                                        <button class="btn-revoke" onclick="revokeDevice('${device.device_id}')">
                                            <i class="material-icons" style="font-size: 14px;">block</i>
                                            Revogar
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    } else {
                        deviceCount.textContent = 'Nenhum dispositivo';
                        document.getElementById('stat-devices').textContent = '0';
                        devicesList.innerHTML = '<div class="loading">Nenhum dispositivo conectado</div>';
                    }
                } else {
                    deviceCount.textContent = 'Nenhum dispositivo';
                    document.getElementById('stat-devices').textContent = '0';
                    devicesList.innerHTML = '<div class="loading">Nenhum dispositivo conectado</div>';
                }
            } catch (error) {
                console.error('Erro ao obter dispositivos:', error);
            }
        }

        async function authorizeDevice(deviceId) {
            try {
                await window.electronAPI.devices.authorize(deviceId);
                showNotification('Dispositivo autorizado!', 'success');
                updateDevices();
            } catch (error) {
                console.error('Erro ao autorizar dispositivo:', error);
                showNotification('Erro ao autorizar dispositivo', 'error');
            }
        }

        async function rejectDevice(deviceId) {
            console.log('üîç REJEITAR DEVICE CHAMADO:', deviceId);
            try {
                // Rejeitar dispositivo (agora remove completamente da lista)
                console.log('üóëÔ∏è Rejeitando e removendo dispositivo...');
                await window.electronAPI.devices.reject(deviceId);
                console.log('‚úÖ Dispositivo rejeitado e removido');
                
                showNotification('Dispositivo rejeitado e removido!', 'success');
                updateDevices(); // Atualizar lista imediatamente
                
            } catch (error) {
                console.error('‚ùå Erro ao rejeitar dispositivo:', error);
                showNotification('Erro ao rejeitar dispositivo', 'error');
            }
        }

        async function revokeDevice(deviceId) {
            try {
                // Primeiro revogar
                await window.electronAPI.devices.revoke(deviceId);
                
                // Aguardar um momento e depois deletar
                setTimeout(async () => {
                    try {
                        await window.electronAPI.devices.delete(deviceId);
                        showNotification('Dispositivo revogado e removido!', 'warning');
                        updateDevices();
                    } catch (deleteError) {
                        console.error('Erro ao deletar dispositivo ap√≥s revoga√ß√£o:', deleteError);
                showNotification('Autoriza√ß√£o revogada!', 'warning');
                updateDevices();
                    }
                }, 1000); // 1 segundo de delay
                
            } catch (error) {
                console.error('Erro ao revogar autoriza√ß√£o:', error);
                showNotification('Erro ao revogar autoriza√ß√£o', 'error');
            }
        }

        async function clearDevicesList() {
            const confirmed = confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nEsta a√ß√£o ir√° APAGAR TODOS os dispositivos DIRETAMENTE DO BANCO DE DADOS!\n\nTem certeza que deseja continuar?');
            
            if (!confirmed) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è DELETANDO TUDO DO BANCO DE DADOS...');
                
                // Deletar TODOS os dispositivos diretamente do banco
                const result = await window.electronAPI.devices.deleteAll();
                
                console.log('‚úÖ RESULTADO:', result);
                showNotification(`üí• BANCO LIMPO! ${result.deletedCount} dispositivos removidos diretamente do SQLite!`, 'success');
                updateDevices();
                
            } catch (error) {
                console.error('‚ùå ERRO CR√çTICO ao limpar banco:', error);
                showNotification('‚ùå ERRO ao limpar banco de dados', 'error');
            }
        }

        // Atualizar logs
        async function updateLogs() {
            try {
                const logs = await window.electronAPI.logs.list();
                const logsContainer = document.getElementById('logs-container');
                
                if (logs && logs.length > 0) {
                    // Ordenar logs por timestamp mais recente primeiro
                    const sortedLogs = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    logsContainer.innerHTML = sortedLogs.slice(0, 50).map(log => `
                        <div class="log-entry">
                            <span class="log-timestamp">[${new Date(log.timestamp).toLocaleString()}]</span>
                            <span class="log-level-${log.level}">${log.level.toUpperCase()}</span>
                            ${log.message}
                        </div>
                    `).join('');
                } else {
                    logsContainer.innerHTML = '<div class="loading">Nenhum log dispon√≠vel</div>';
                }
            } catch (error) {
                console.error('Erro ao obter logs:', error);
            }
        }

        // Fun√ß√µes de a√ß√£o
        function openTerminal() {
            if (serverStatus.running) {
                window.open(`http://${serverStatus.localIP}:${serverStatus.port}/maquina`, '_blank');
            } else {
                showNotification('Servidor n√£o est√° rodando', 'error');
            }
        }

        function openExternal() {
            if (serverStatus.tunnelUrl) {
                window.open(serverStatus.tunnelUrl, '_blank');
            } else {
                showNotification('Acesso externo n√£o est√° dispon√≠vel', 'error');
            }
        }

        // Fun√ß√µes de Produtos
        async function loadProducts() {
            try {
                const productsList = await window.electronAPI.products.list();
                products = productsList || [];
                displayProducts();
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                showNotification('Erro ao carregar produtos', 'error');
            }
        }

        function switchProductCategory(category) {
            currentProductCategory = category;
            
            // Atualizar tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayProducts();
        }

        function displayProducts() {
            const productsList = document.getElementById('products-list');
            const categoryProducts = products.filter(p => p.category === currentProductCategory);
            
            if (categoryProducts.length > 0) {
                productsList.innerHTML = categoryProducts.map(product => `
                    <div class="product-item">
                        <div class="product-info">
                            <div class="product-name">
                                <strong>${product.name}</strong>
                                <span class="product-code">${product.category}</span>
                            </div>
                        </div>
                        <div class="product-actions">
                            <button class="btn-edit" onclick="editProduct(${product.id})">
                                <i class="material-icons" style="font-size: 14px;">edit</i>
                                Editar
                            </button>
                            <button class="btn-delete" onclick="deleteProduct(${product.id})">
                                <i class="material-icons" style="font-size: 14px;">delete</i>
                                Excluir
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                productsList.innerHTML = '<div class="loading">Nenhum produto nesta categoria</div>';
            }
        }

        // Fun√ß√£o addNewProduct duplicada removida - usando vers√£o mais completa abaixo

        async function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            const newName = prompt('Nome do produto:', product.name);
            if (!newName) return;
            
            try {
                const result = await window.electronAPI.products.update({
                    id: id,
                    name: newName
                });
                
                if (result.success) {
                    showNotification('Produto atualizado com sucesso', 'success');
                    loadProducts();
                } else {
                    showNotification('Erro ao atualizar produto', 'error');
                }
            } catch (error) {
                console.error('Erro ao atualizar produto:', error);
                showNotification('Erro ao atualizar produto', 'error');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Tem certeza que deseja excluir este produto?')) return;
            
            try {
                const result = await window.electronAPI.products.delete(id);
                
                if (result.success) {
                    showNotification('Produto exclu√≠do com sucesso', 'success');
                    loadProducts();
                } else {
                    showNotification('Erro ao excluir produto', 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir produto:', error);
                showNotification('Erro ao excluir produto', 'error');
            }
        }

        // Fun√ß√µes de Ordens
        async function loadOrders() {
            try {
                console.log('üîç Carregando ordens do sistema...');
                console.log('üîç Verificando disponibilidade da API electronAPI.orders...');
                
                if (!window.electronAPI || !window.electronAPI.orders || !window.electronAPI.orders.list) {
                    throw new Error('API electronAPI.orders.list n√£o est√° dispon√≠vel');
                }
                
                console.log('‚úÖ API dispon√≠vel, fazendo chamada...');
                const ordersList = await window.electronAPI.orders.list();
                console.log('üì¶ Resposta da API recebida:', ordersList);
                console.log('üì¶ Tipo da resposta:', typeof ordersList, 'Array:', Array.isArray(ordersList));
                
                if (ordersList === null || ordersList === undefined) {
                    console.warn('‚ö†Ô∏è API retornou null/undefined');
                    orders = [];
                } else {
                    orders = ordersList || [];
                }
                
                console.log(`‚úÖ ${orders.length} ordens carregadas para exibi√ß√£o`);
                
                // Atualizar estat√≠stica
                const statElement = document.getElementById('stat-orders');
                if (statElement) {
                    statElement.textContent = orders.length;
                }
                
                displayOrders();
            } catch (error) {
                console.error('‚ùå Erro ao carregar ordens:', error);
                console.error('‚ùå Stack trace:', error.stack);
                showNotification('Erro ao carregar ordens: ' + error.message, 'error');
                
                // Exibir mensagem de erro na lista
                const ordersList = document.getElementById('orders-list');
                const ordersCount = document.getElementById('orders-count');
                
                if (ordersList) {
                    ordersList.innerHTML = `
                        <div class="loading error" style="text-align: center; padding: 40px; color: #e74c3c;">
                            <i class="material-icons" style="font-size: 48px; margin-bottom: 10px;">error</i>
                            <div>Erro ao carregar ordens</div>
                            <div style="font-size: 12px; margin-top: 5px;">${error.message}</div>
                            <button onclick="loadOrders()" style="margin-top: 10px; padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">Tentar Novamente</button>
                        </div>
                    `;
                }
                
                if (ordersCount) {
                    ordersCount.textContent = 'Erro ao carregar ordens';
                }
            }
        }

        function displayOrders() {
            const ordersList = document.getElementById('orders-list');
            const ordersCount = document.getElementById('orders-count');
            
            console.log('üìã Exibindo ordens:', orders);
            
            if (!ordersList || !ordersCount) {
                console.error('‚ùå Elementos DOM n√£o encontrados (orders-list ou orders-count)');
                return;
            }
            
            if (orders && orders.length > 0) {
                const completed = orders.filter(o => o.status === 'completed').length;
                const pending = orders.filter(o => o.status === 'pending').length;
                
                ordersCount.textContent = `${orders.length} ordens ‚Ä¢ ${completed} conclu√≠das ‚Ä¢ ${pending} pendentes`;
                
                // Ordenar por data mais recente primeiro
                const sortedOrders = orders.sort((a, b) => {
                    const dateA = new Date(a.created_at || Date.now());
                    const dateB = new Date(b.created_at || Date.now());
                    return dateB - dateA;
                });
                
                ordersList.innerHTML = sortedOrders.map(order => {
                    try {
                        // Parsing mais robusto do products_data
                        let products = [];
                        if (order.products_data) {
                            if (typeof order.products_data === 'string') {
                                try {
                                    products = JSON.parse(order.products_data);
                                } catch (parseError) {
                                    console.warn('‚ö†Ô∏è Erro ao parsear products_data para ordem', order.order_code, parseError);
                                    products = [];
                                }
                            } else if (Array.isArray(order.products_data)) {
                                products = order.products_data;
                            }
                        }
                        
                        // Garantir que products √© um array
                        if (!Array.isArray(products)) {
                            products = [];
                        }
                        
                        const totalWeight = products.reduce((total, product) => {
                            return total + (parseFloat(product.totalWeight) || 0);
                        }, 0);
                        
                        return `
                        <div class="order-item">
                            <div class="order-header">
                                <div class="order-code">Ordem: ${order.order_code || 'N/A'}</div>
                                <div class="order-status ${order.status || 'unknown'}">${order.status === 'completed' ? 'Conclu√≠da' : 'Pendente'}</div>
                            </div>
                            <div class="order-details">
                                <div class="order-meta">
                                    <span>Data: ${order.created_at ? new Date(order.created_at).toLocaleString() : 'Data n√£o dispon√≠vel'}</span>
                                    <span>Produtos: ${products.length}</span>
                                    ${totalWeight > 0 ? `<span style="color: #e74c3c; font-weight: bold;">Peso Total: ${totalWeight.toFixed(2)}kg</span>` : ''}
                                    ${order.device_id ? `<span>Dispositivo: ${order.device_id}</span>` : ''}
                                </div>
                                <div class="order-products">
                                    ${products.length > 0 ? products.slice(0, 3).map(product => `
                                        <div class="order-product">
                                            <span>${product.name || 'Produto sem nome'}</span>
                                            <span>Contador: ${product.counter || 0}</span>
                                            ${product.totalWeight ? `<span style="color: #27ae60;">Peso: ${product.totalWeight}kg</span>` : ''}
                                        </div>
                                    `).join('') : '<div style="color: #7f8c8d; font-style: italic;">Nenhum produto encontrado</div>'}
                                    ${products.length > 3 ? `<div style="text-align: center; color: #7f8c8d; font-size: 12px;">... e mais ${products.length - 3} produtos</div>` : ''}
                                </div>
                            </div>
                        </div>
                        `;
                    } catch (error) {
                        console.error('‚ùå Erro ao renderizar ordem:', order, error);
                        return `
                        <div class="order-item" style="border: 1px solid #e74c3c; background: #fdf2f2;">
                            <div class="order-header">
                                <div class="order-code">Ordem: ${order.order_code || 'N/A'} (Erro de renderiza√ß√£o)</div>
                                <div class="order-status error">Erro</div>
                            </div>
                            <div class="order-details">
                                <div style="color: #e74c3c; font-size: 12px;">Erro ao exibir dados desta ordem</div>
                            </div>
                        </div>
                        `;
                    }
                }).join('');
            } else {
                ordersCount.textContent = 'Nenhuma ordem registrada';
                ordersList.innerHTML = '<div class="loading" style="text-align: center; padding: 40px; color: #7f8c8d;">Nenhuma ordem dispon√≠vel</div>';
            }
        }

        function refreshOrders() {
            loadOrders();
            showNotification('Ordens atualizadas', 'success');
        }

        async function clearCompletedOrders() {
            if (!confirm('Tem certeza que deseja limpar todas as ordens conclu√≠das?')) return;
            
            try {
                const result = await window.electronAPI.orders.clearCompleted();
                
                if (result.success) {
                    showNotification('Ordens conclu√≠das removidas', 'success');
                    loadOrders();
                } else {
                    showNotification('Erro ao limpar ordens', 'error');
                }
            } catch (error) {
                console.error('Erro ao limpar ordens:', error);
                showNotification('Erro ao limpar ordens', 'error');
            }
        }

        // Fun√ß√µes de produtos
        async function loadProducts() {
            try {
                console.log('üîç Carregando produtos...');
                const allProducts = await window.electronAPI.products.list();
                products = allProducts || [];
                
                console.log(`üì¶ ${products.length} produtos carregados:`, products);
                
                // Atualizar estat√≠stica
                const statElement = document.getElementById('stat-products');
                if (statElement) {
                    statElement.textContent = products.length;
                }
                
                // Exibir produtos da categoria atual
                displayProductsByCategory(currentProductCategory);
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                showNotification('Erro ao carregar produtos', 'error');
            }
        }

        function switchProductCategory(category) {
            currentProductCategory = category;
            
            // Atualizar abas visuais
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.category === category) {
                    tab.classList.add('active');
                }
            });
            
            displayProductsByCategory(category);
        }

        function displayProductsByCategory(category) {
            const productsList = document.getElementById('products-list');
            
            // Filtrar produtos da categoria
            const categoryProducts = products.filter(p => p.category === category);
            
            if (categoryProducts.length > 0) {
                productsList.innerHTML = categoryProducts.map(product => `
                    <div class="product-item">
                        <div class="product-info">
                            <div class="product-name">
                                <strong>${product.name}</strong>
                                <span class="product-code">(${product.code})</span>
                            </div>
                            <div class="product-details">
                                <span>Categoria: ${product.category}</span>
                                <span>Unidade: ${product.unit}</span>
                            </div>
                            <div class="product-description">${product.description || 'Sem descri√ß√£o'}</div>
                            <div class="product-actions">
                                <button class="btn-edit" onclick="editProduct(${product.id})">
                                    <i class="material-icons" style="font-size: 14px;">edit</i>
                                    Editar
                                </button>
                                <button class="btn-delete" onclick="deleteProduct(${product.id})">
                                    <i class="material-icons" style="font-size: 14px;">delete</i>
                                    Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                productsList.innerHTML = `<div class="loading">Nenhum produto na categoria ${category}</div>`;
            }
        }

        // Fun√ß√£o removida - usar openAddProductModal() em vez disso

        function closeAddProductModal() {
            document.getElementById('addProductModal').style.display = 'none';
            
            // Limpa os campos
            document.getElementById('modalProductName').value = '';
            document.getElementById('modalProductDescription').value = '';
            document.getElementById('modalProductUnit').value = 'un';
        }

        // Fun√ß√£o submitNewProduct duplicada removida - mantendo apenas a vers√£o abaixo

        async function submitNewProduct() {
            const name = document.getElementById('modalProductName').value.trim();
            const category = document.getElementById('modalProductCategory').value;
            const description = document.getElementById('modalProductDescription').value.trim();
            const unit = document.getElementById('modalProductUnit').value.trim() || 'un';
            
            if (!name) {
                return showNotification('Nome do produto √© obrigat√≥rio', 'error');
            }
            
            try {
                const newProduct = {
                    name,
                    description,
                    category,
                    unit
                };
                
                const result = await window.electronAPI.products.create(newProduct);
                
                if (result.success) {
                    showNotification('Produto adicionado com sucesso!', 'success');
                    closeAddProductModal();
                    loadProducts();
                } else {
                    showNotification('Erro ao adicionar produto: ' + (result.message || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                console.error('Erro ao adicionar produto:', error);
                showNotification('Erro ao adicionar produto', 'error');
            }
        }

        function openAddProductModal() {
            document.getElementById('addProductModal').style.display = 'flex';
            
            // Define a categoria atual no select
            const categorySelect = document.getElementById('modalProductCategory');
            if (currentProductCategory) {
                categorySelect.value = currentProductCategory;
            }
            
            // Foca no campo de nome
            document.getElementById('modalProductName').focus();
        }

        function closeAddProductModal() {
            document.getElementById('addProductModal').style.display = 'none';
        }

        // Fun√ß√£o para importar produtos
        function importProducts() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.csv,.xlsx';
            input.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    showNotification('Importando produtos...', 'info');
                    
                    if (file.type === 'application/json' || file.name.endsWith('.json')) {
                        const text = await file.text();
                        const products = JSON.parse(text);
                        
                        if (Array.isArray(products)) {
                            let imported = 0;
                            for (const product of products) {
                                if (product.codigo && product.nome) {
                                    try {
                                        await window.electronAPI.products.create(product);
                                        imported++;
                                    } catch (error) {
                                        console.warn('Erro ao importar produto:', product.codigo, error);
                                    }
                                }
                            }
                            showNotification(`${imported} produtos importados com sucesso`, 'success');
                            loadProducts(); // Recarregar lista
                        } else {
                            showNotification('Arquivo JSON deve conter um array de produtos', 'error');
                        }
                    } else {
                        showNotification('Formato de arquivo n√£o suportado. Use JSON apenas.', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao importar produtos:', error);
                    showNotification('Erro ao importar produtos: ' + error.message, 'error');
                }
            };
            input.click();
        }

        // Fun√ß√£o para exportar produtos
        function exportProducts() {
            try {
                showNotification('Exportando produtos...', 'info');
                
                window.electronAPI.products.list().then(products => {
                    if (!products || products.length === 0) {
                        showNotification('Nenhum produto para exportar', 'info');
                        return;
                    }
                    
                    const dataStr = JSON.stringify(products, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `produtos_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    
                    showNotification(`${products.length} produtos exportados com sucesso`, 'success');
                }).catch(error => {
                    console.error('Erro ao exportar produtos:', error);
                    showNotification('Erro ao exportar produtos: ' + error.message, 'error');
                });
            } catch (error) {
                console.error('Erro ao exportar produtos:', error);
                showNotification('Erro ao exportar produtos: ' + error.message, 'error');
            }
        }

        // Fun√ß√£o para exportar ordens
        function exportOrders() {
            try {
                showNotification('Exportando ordens...', 'info');
                
                window.electronAPI.orders.list().then(orders => {
                    if (!orders || orders.length === 0) {
                        showNotification('Nenhuma ordem para exportar', 'info');
                        return;
                    }
                    
                    const dataStr = JSON.stringify(orders, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `ordens_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    
                    showNotification(`${orders.length} ordens exportadas com sucesso`, 'success');
                }).catch(error => {
                    console.error('Erro ao exportar ordens:', error);
                    showNotification('Erro ao exportar ordens: ' + error.message, 'error');
                });
            } catch (error) {
                console.error('Erro ao exportar ordens:', error);
                showNotification('Erro ao exportar ordens: ' + error.message, 'error');
            }
        }

        function refreshDevices() {
            updateDevices();
            showNotification('Dispositivos atualizados', 'success');
        }

        function refreshLogs() {
            updateLogs();
            showNotification('Logs atualizados', 'success');
        }

        async function clearLogs() {
            try {
                if (confirm('Tem certeza que deseja limpar todos os logs?')) {
                    await window.electronAPI.logs.clear();
                    await updateLogs();
                    showNotification('Logs limpos com sucesso', 'success');
                }
            } catch (error) {
                console.error('Erro ao limpar logs:', error);
                showNotification('Erro ao limpar logs', 'error');
            }
        }

        function exportDevices() {
            // Implementar exporta√ß√£o
            showNotification('Funcionalidade de exporta√ß√£o em desenvolvimento', 'info');
        }

        function exportLogs() {
            // Implementar exporta√ß√£o
            showNotification('Funcionalidade de exporta√ß√£o em desenvolvimento', 'info');
        }

        function saveSettings() {
            showNotification('Configura√ß√µes salvas', 'success');
        }

        function backupData() {
            showNotification('Backup em desenvolvimento', 'info');
        }

        function restoreData() {
            showNotification('Restaura√ß√£o em desenvolvimento', 'info');
        }

        // Auto-Update Functions
        let updateListeners = [];

        async function checkForUpdates() {
            const btn = document.getElementById('check-updates-btn');
            const statusEl = document.getElementById('update-status');
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="material-icons">hourglass_empty</i> Verificando...';
                statusEl.textContent = 'Verificando atualiza√ß√µes...';
                statusEl.className = 'update-status-checking';
                
                hideUpdateElements();
                
                await window.electronAPI.updater.check();
                
            } catch (error) {
                console.error('Erro ao verificar atualiza√ß√µes:', error);
                statusEl.textContent = 'Erro ao verificar atualiza√ß√µes';
                statusEl.className = 'update-status-error';
                showNotification('Erro ao verificar atualiza√ß√µes: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="material-icons">search</i> Verificar Atualiza√ß√µes';
            }
        }

        async function downloadUpdate() {
            const btn = document.getElementById('download-update-btn');
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="material-icons">hourglass_empty</i> Baixando...';
                
                document.getElementById('update-progress-container').style.display = 'block';
                
                await window.electronAPI.updater.download();
                
            } catch (error) {
                console.error('Erro ao baixar atualiza√ß√£o:', error);
                showNotification('Erro ao baixar atualiza√ß√£o: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="material-icons">download</i> Baixar Atualiza√ß√£o';
            }
        }

        async function installUpdate() {
            if (confirm('O aplicativo ser√° fechado e atualizado. Deseja continuar?')) {
                try {
                    await window.electronAPI.updater.install();
                } catch (error) {
                    console.error('Erro ao instalar atualiza√ß√£o:', error);
                    showNotification('Erro ao instalar atualiza√ß√£o: ' + error.message, 'error');
                }
            }
        }

        function hideUpdateElements() {
            document.getElementById('update-version-info').style.display = 'none';
            document.getElementById('update-progress-container').style.display = 'none';
            document.getElementById('update-error-container').style.display = 'none';
            document.getElementById('download-update-btn').style.display = 'none';
            document.getElementById('install-update-btn').style.display = 'none';
        }

        function showUpdateError(message) {
            const container = document.getElementById('update-error-container');
            const messageEl = document.getElementById('update-error-message');
            
            messageEl.textContent = message;
            container.style.display = 'block';
        }

        function updateProgressBar(percent, details) {
            const progressBar = document.getElementById('update-progress-bar');
            const progressDetails = document.getElementById('update-progress-details');
            
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
            
            if (details) {
                progressDetails.textContent = details;
            }
        }

        function setupUpdateListeners() {
            // Cleanup previous listeners
            updateListeners.forEach(cleanup => cleanup());
            updateListeners = [];

            // Checking for updates
            updateListeners.push(
                window.electronAPI.updater.onChecking(() => {
                    const statusEl = document.getElementById('update-status');
                    statusEl.textContent = 'Verificando atualiza√ß√µes...';
                    statusEl.className = 'update-status-checking';
                })
            );

            // Update available
            updateListeners.push(
                window.electronAPI.updater.onAvailable((info) => {
                    const statusEl = document.getElementById('update-status');
                    const versionEl = document.getElementById('available-version');
                    
                    statusEl.textContent = 'Atualiza√ß√£o dispon√≠vel!';
                    statusEl.className = 'update-status-available';
                    
                    versionEl.textContent = info.version;
                    document.getElementById('update-version-info').style.display = 'block';
                    document.getElementById('download-update-btn').style.display = 'inline-block';
                    
                    showNotification(`Nova vers√£o ${info.version} dispon√≠vel!`, 'info');
                })
            );

            // Update not available
            updateListeners.push(
                window.electronAPI.updater.onNotAvailable(() => {
                    const statusEl = document.getElementById('update-status');
                    statusEl.textContent = 'Aplica√ß√£o est√° atualizada';
                    statusEl.className = 'update-status-available';
                    
                    showNotification('Aplica√ß√£o est√° na vers√£o mais recente', 'success');
                })
            );

            // Download progress
            updateListeners.push(
                window.electronAPI.updater.onProgress((progressObj) => {
                    const details = `${Math.round(progressObj.transferred / 1024 / 1024)} MB de ${Math.round(progressObj.total / 1024 / 1024)} MB`;
                    updateProgressBar(progressObj.percent, details);
                })
            );

            // Update downloaded
            updateListeners.push(
                window.electronAPI.updater.onDownloaded(() => {
                    const statusEl = document.getElementById('update-status');
                    const downloadBtn = document.getElementById('download-update-btn');
                    const installBtn = document.getElementById('install-update-btn');
                    
                    statusEl.textContent = 'Atualiza√ß√£o pronta para instalar';
                    statusEl.className = 'update-status-ready';
                    
                    downloadBtn.style.display = 'none';
                    installBtn.style.display = 'inline-block';
                    
                    updateProgressBar(100, 'Download conclu√≠do');
                    
                    showNotification('Atualiza√ß√£o baixada! Clique em "Instalar e Reiniciar"', 'success');
                })
            );

            // Update error
            updateListeners.push(
                window.electronAPI.updater.onError((message) => {
                    const statusEl = document.getElementById('update-status');
                    
                    statusEl.textContent = 'Erro na atualiza√ß√£o';
                    statusEl.className = 'update-status-error';
                    
                    showUpdateError(message);
                    showNotification('Erro na atualiza√ß√£o: ' + message, 'error');
                    
                    // Reset buttons
                    document.getElementById('download-update-btn').style.display = 'none';
                    document.getElementById('install-update-btn').style.display = 'none';
                })
            );

            // Update installing (silent installation starting)
            updateListeners.push(
                window.electronAPI.updater.onInstalling(() => {
                    const statusEl = document.getElementById('update-status');
                    
                    statusEl.textContent = 'Instalando atualiza√ß√£o...';
                    statusEl.className = 'update-status-checking';
                    
                    // Hide install button during installation
                    document.getElementById('install-update-btn').style.display = 'none';
                    
                    showNotification('Instalando atualiza√ß√£o silenciosamente...', 'info');
                })
            );

            // Update installed (silent installation completed)
            updateListeners.push(
                window.electronAPI.updater.onInstalled(() => {
                    const statusEl = document.getElementById('update-status');
                    
                    statusEl.textContent = 'Atualiza√ß√£o instalada! Reiniciando...';
                    statusEl.className = 'update-status-available';
                    
                    showNotification('Atualiza√ß√£o instalada com sucesso! O aplicativo ser√° reiniciado.', 'success');
                })
            );
        }

        // Fun√ß√£o para copiar para clipboard
        function copyToClipboard(element) {
            const text = element.textContent;
            if (text && text !== '-' && text !== 'Detectando...' && text !== 'Servidor parado') {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification(`Copiado: ${text}`, 'success');
                }).catch(() => {
                    showNotification('Erro ao copiar', 'error');
                });
            }
        }

        // Sistema de notifica√ß√µes
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 9999;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                ${type === 'success' ? 'background: #27ae60;' : ''}
                ${type === 'error' ? 'background: #e74c3c;' : ''}
                ${type === 'info' ? 'background: #3498db;' : ''}
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof window.electronAPI === 'undefined') {
                showNotification('Erro: API do Electron n√£o dispon√≠vel', 'error');
                return;
            }
            
            // Setup auto-update listeners
            setupUpdateListeners();
            
            // Atualiza√ß√£o inicial
            updateStatus();
            updateDevices();
            updateLogs();
            loadProducts();
            
            // Verificar atualiza√ß√µes automaticamente (ap√≥s 10 segundos)
            setTimeout(() => {
                checkForUpdates();
            }, 10000);
            
            // Atualizar a cada 5 segundos
            updateInterval = setInterval(() => {
                updateStatus();
                if (currentTab === 'products') loadProducts();
                if (currentTab === 'orders') loadOrders();
                if (currentTab === 'devices') updateDevices();
                if (currentTab === 'logs') updateLogs();
            }, 5000);
            
            showNotification('Sistema inicializado com sucesso', 'success');
        });

        // Limpeza ao fechar
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            // Cleanup update listeners
            updateListeners.forEach(cleanup => cleanup());
        });
    </script>
</body>
</html>